#Réalisé par Ivann LARUELLE / ivann.laruelle@utt.fr
---
  - name: Installation des paquets master
    package: 
      name: "{{ item }}"
      state: latest
    with_items:
      - ldnsutils
      - haveged

  - file:
      path: /etc/nsd/keys
      state: directory
      owner: nsd
      mode: "710"
    when: not ansible_check_mode

  - include_tasks: genZone.yml
    loop: "{{ domains }}"
    tags:
      - zoneGeneration

  - name: Generation du fichier de configuration 
    template:
      src: nsd-master.conf.j2
      dest: /etc/nsd/nsd.conf
      backup: yes
      owner: nsd
      mode: "740"
      validate: nsd-checkconf %s

  - name: Génération des clefs, clefs DS
    include_tasks: genKey.yml
    loop: "{{ domains }}"
    tags: 
      - clefsGeneration

  - name: Signature des zones
    include_tasks: signZone.yml
    loop: "{{ domains }}"
    tags: 
      - zoneSignature

  - name: Redemarrage de nsd
    service:
      name: nsd
      state: restarted
      enabled: yes