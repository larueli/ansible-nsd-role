#Réalisé par Ivann LARUELLE / ivann.laruelle@utt.fr
---
  - stat:
      path: /etc/nsd/zones/keys/{{ item.domain }}
    register: dossierClefs
  - name: Verification de l'existence de clefs DNSSEC déjà créées pour {{ item.domain }}
    debug:
      msg: "{{ dossierClefs.stat.exists }}"

  - file:
      path: /etc/nsd/keys/{{ item.domain }}
      state: directory
      owner: nsd
      mode: "700"

  - name: Generation des clefs pour {{ item.domain }}
    block:
    - name: Generation de clefs ZSK pour {{ item.domain }}
      shell: ldns-keygen -a {{ DNNSEC_keys.algorithm }} -b {{ DNNSEC_keys.size }} {{ item.domain }}
      args:
        chdir: /etc/nsd/keys/{{ item.domain }}
      register: zsk

    - name: Génération de clefs KSK pour {{ item.domain }}
      shell: ldns-keygen -k -a {{ DNNSEC_keys.algorithm }} -b {{ DNNSEC_keys.size }} {{ item.domain }}
      args: 
        chdir: /etc/nsd/keys/{{ item.domain }}
      register: ksk

    - copy:
        content: "{{ zsk.stdout }}"
        dest: /etc/nsd/keys/{{ item.domain }}/zsk
        owner: nsd
        mode: "700"
      when: not ansible_check_mode

    - copy:
        content: "{{ ksk.stdout }}"
        dest: /etc/nsd/keys/{{ item.domain }}/ksk
        owner: nsd
        mode: "700"
      when: not ansible_check_mode

    when: dossierClefs.stat.exists == False